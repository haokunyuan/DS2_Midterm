---
title: "final all model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(caret)
library(doParallel)
cl <- makePSOCKcluster(16)
registerDoParallel(cl)
```

# Exploratory analysis 
```{r}
# read and process data
dept1_data = read_csv("../data/final_data_one_department.csv") %>% janitor::clean_names()
head(dept1_data)
# remove index 
dept1_data = dept1_data[-1]
# data type changed. 
dept1_data$is_holiday = as.factor(dept1_data$is_holiday)
dept1_data$type = as.factor(dept1_data$type)
dept1_data$store = as.factor(dept1_data$store)
#skimr::skim(dept1_data)
```
```{r}
# create a data frame for plot only 
dept1_data_plot = dept1_data
dept1_data_plot$is_holiday = as.numeric(dept1_data_plot$is_holiday)
dept1_data_plot$type = as.numeric(as.factor(dept1_data_plot$type))
dept1_data_plot$store = as.numeric(dept1_data_plot$store)
```

# distribtuion of response and corrlation 

```{r}
# figure 1 distribution of response 
dept1_data %>% 
  ggplot() + 
  geom_histogram(aes(x = weekly_sales))+
  theme_minimal()+
  ggtitle("Distribution of Weekly Sales")
```

```{r, fig.height = 4}
# set theme 
theme1 <- trellis.par.get()
theme1$plot.symbol$col <- rgb(.2, .4, .2, .5)
theme1$plot.symbol$pch <- 16
theme1$plot.line$col <- rgb(.8, .1, .1, 1)
theme1$plot.line$lwd <- 2
theme1$strip.background$col <- rgb(.0, .2, .6, .2)
trellis.par.set(theme1)

featurePlot(x = dept1_data_plot[,c(-3)],
            y = dept1_data$weekly_sales,
            span = .5, 
            plot = "scatter",
            type = c("p","smooth"),
            layout= c(4,3))


```

```{r}
plot_x = as.matrix(dept1_data_plot)
corrplot::corrplot(cor(plot_x))
```
# test and train split
```{r}
# seperate test and train 
smp_size <- floor(0.75 * nrow(dept1_data))
set.seed(123)
train_ind <- sample(seq_len(nrow(dept1_data)), size = smp_size)

train.data <-dept1_data[train_ind, ]
test.data  <- dept1_data[-train_ind, ]

train_matrix_x <- model.matrix(weekly_sales~.,train.data)[,-1]
train_matrix_y <- train.data$weekly_sales

test_matrix_x =  model.matrix(weekly_sales~.,test.data)[,-1]
test_matrix_y =  test.data$weekly_sales
```


# linear models 
```{r}
ctrl1 <- trainControl(method = "repeatedcv", number = 10, repeats = 5)
#linear 
set.seed(2)
lm.fit <- train(weekly_sales~.,
                data= train.data,
                method = "lm",
                trControl = ctrl1)
```

Ridge
```{r}
#ridge
set.seed(2)
ridge.fit <- train(weekly_sales~.,
                   data= train.data,
                   method = "glmnet",
                   tuneGrid = expand.grid(alpha = 0, 
                                          lambda = exp(seq(0, 20, length=50))),
                   # preProc = c("center", "scale"),
                   trControl = ctrl1)

plot(ridge.fit, xTrans = function(x) log(x))
```



LASSO
```{r}
set.seed(2)
lasso.fit <- train(weekly_sales~.,
                   data= train.data,
                   method = "glmnet",
                   tuneGrid = expand.grid(alpha = 1, 
                                          lambda = exp(seq(2,10, length=100))),
                   # preProc = c("center", "scale"),
                   trControl = ctrl1)
plot(lasso.fit, xTrans = function(x) log(x))
```

Elastic net 
```{r}
set.seed(2)
enet.fit <- train(weekly_sales~.,
                   data= train.data,
                   method = "glmnet",
                   tuneGrid = expand.grid(alpha = seq(0,1,0.1), 
                                          lambda = exp(seq(0,15, length=100))),
                   # preProc = c("center", "scale"),
                   trControl = ctrl1)
plot(enet.fit, xTrans = function(x) log(x))
```
PCR
```{r}
set.seed(2)
pcr.fit <- train(weekly_sales~.,
                 data= train.data,
                 method = "pcr",
                 tuneLength = 80,
                 trControl = ctrl1,
                 preProc = c("center", "scale") )
# # need to preprocess your data when using predict()
#trans <- preProcess(x, method = c("center", "scale"))
# predy2.pcr2 <- predict(pcr.fit$finalModel, 
#                        newdata = predict(trans,test.data),
#                        ncomp = pcr.fit$bestTune[[1]])
ggplot(pcr.fit, highlight = TRUE)+ theme_bw()
```
PLS
```{r}
set.seed(2)
pls.fit <-train(weekly_sales~.,
                data= train.data,
                method = "pls",
                tuneLength = 34,
                trControl = ctrl1,
                scale = TRUE)

# predy2.pls2 <-predict(pls.fit$finalModel,
#                       newdata = test.data,
#                       ncomp = pls.fit$bestTune$ncomp)
ggplot(pls.fit, highlight = TRUE)+ theme_bw()
```

# gam 
```{r}
set.seed(2)
gam.fit <-train(weekly_sales~.,
                data= train.data,
                method = "gam",
                tuneGrid = data.frame(method = "GCV.Cp",
                                      select = c(TRUE,FALSE)),
                trControl = ctrl1)

gam.fit$finalModel
ggplot(gam.fit)+ theme_bw()
```
```{r}
set.seed(2)
gam.fit1 <-train(train_matrix_x,
                train_matrix_y,
                method = "gam",
                tuneGrid = data.frame(method = "GCV.Cp",
                                      select = c(TRUE,FALSE)),
                trControl = ctrl1)
```

# Tree Based model 
bagging 
```{r}
ctrl <- trainControl(method = "cv")
set.seed(1)
bg.fit <- train(weekly_sales ~ ., 
                train.data,
                method = "ranger",
                tuneGrid = expand.grid(
                          mtry = 55, 
                          splitrule = "variance",
                          min.node.size = 10 ),
                importance = "permutation",
                scale.permutation.importance = "TRUE",
                trControl = ctrl1)

# plot variable of importance 
barplot(sort(ranger::importance(bg.fit$finalModel), decreasing = FALSE),
        las = 2, horiz = TRUE, cex.names = 0.7)
```
Random forest 
```{r}
rf.grid <- expand.grid(mtry = seq(4,134,10),
                       splitrule = "variance",
                       min.node.size = 10)
set.seed(1)
rf.fit <- train(weekly_sales~., df,
                method = "ranger",
                tuneGrid = rf.grid,
                trControl = ctrl)

#rf.fit$bestTune
ggplot(rf.fit, highlight = TRUE)
```



Model Selection
```{r}
resamp <- resamples(list(lasso = lasso.fit, 
                         ridge = ridge.fit,
                         enet = enet.fit,
                         lm = lm.fit,
                         pcr = pcr.fit,
                         pls = pls.fit,
                         gam = gam.fit))

bwplot(resamp, metric = "RMSE")
```



































